import React, { useState, useEffect } from 'react';
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  doc, 
  onSnapshot, 
  serverTimestamp, 
  writeBatch
} from "firebase/firestore";
import { 
  Layout, 
  Calendar, 
  CheckSquare, 
  MessageSquare, 
  Plus, 
  Clock, 
  CheckCircle2,
  Circle,
  Trash2,
  User,
  FileText,
  CreditCard,
  Target,
  Users,
  X,
  Briefcase,
  Link as LinkIcon,
  FileEdit
} from 'lucide-react';

// --- Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const analytics = getAnalytics(app);

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Team Members ---
const TEAM = [
  { id: 'eliran', name: 'אלירן', role: 'מנהל פרויקט', color: 'bg-blue-100 text-blue-700 border-blue-200' },
  { id: 'raphael', name: 'רפאל', role: 'מעצב', color: 'bg-purple-100 text-purple-700 border-purple-200' },
  { id: 'roy', name: 'רועי', role: 'מפתח', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' },
];

// --- Clients ---
const CLIENTS = [
  { id: 'iris', name: 'איריס', role: 'לקוחה', color: 'bg-orange-100 text-orange-700 border-orange-200' },
  { id: 'shani', name: 'שני', role: 'לקוחה', color: 'bg-orange-100 text-orange-700 border-orange-200' },
];

// Combine for easy lookup
const ALL_PEOPLE = [...TEAM, ...CLIENTS];

// --- Project Details ---
const PROJECT_DETAILS = {
  clientName: "מוזיאון העמק",
  contactPerson: "אלין",
  // Budget hidden as per request
  modules: [
    "אתר תדמית (וורדפרס + אלמנטור)",
    "קטלוג כלים חקלאיים",
    "פלטפורמת סיפורי מייסדים",
    "מערכת אירועים והרשמה"
  ]
};

// --- Initial Stages (Cleaned - No Payments) ---
const INITIAL_STAGES = [
  { order: 1, title: 'חתימה ויציאה לדרך', status: 'done', description: 'אישור הצעה ותחילת עבודה (שוטף+60)' },
  { order: 2, title: 'שלב א\': אפיון ועיצוב', status: 'in-progress', description: 'איסוף חומרים, סקיצות עיצוב, אישור מול לקוח' },
  { order: 3, title: 'שלב ב\': פיתוח תשתית ומודולים', status: 'pending', description: 'וורדפרס, קטלוג כלים, סיפורי מייסדים, אירועים' },
  { order: 4, title: 'שלב ג\': הדרכה', status: 'pending', description: 'הדרכה על מערכת הניהול לצוות המוזיאון' },
  { order: 5, title: 'שלב ד\': QA ובדיקות', status: 'pending', description: 'התאמה למובייל, דפדפנים, תיקונים' },
  { order: 6, title: 'שלב ה\': עלייה לאוויר', status: 'pending', description: 'העברת דומיין, הפניות 301' },
];

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('overview'); 
  
  // Data State
  const [stages, setStages] = useState([]);
  const [meetings, setMeetings] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // UI State
  const [taskFilter, setTaskFilter] = useState('all'); 
  
  // Form States
  const [isMeetingModalOpen, setIsMeetingModalOpen] = useState(false);
  const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
  
  // Added 'link' and 'fullDoc' to state
  const [newMeeting, setNewMeeting] = useState({ 
    title: '', 
    date: new Date().toISOString().split('T')[0], 
    summary: '', 
    fullDoc: '',
    link: '',
    attendees: [] 
  });
  
  const [newTask, setNewTask] = useState({ title: '', assignee: TEAM[0].id, priority: 'normal' });

  // --- Auth Effect ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth Error", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Data Fetching ---
  useEffect(() => {
    if (!user) return;

    // Stages
    const stagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'stages');
    const unsubStages = onSnapshot(stagesRef, async (snapshot) => {
      const fetchedStages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const hasCleanStages = fetchedStages.some(s => s.title.includes('יציאה לדרך'));
      
      if (fetchedStages.length === 0 || !hasCleanStages) {
        const batch = writeBatch(db);
        snapshot.docs.forEach((doc) => batch.delete(doc.ref));
        INITIAL_STAGES.forEach(stage => {
          const newRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'stages'));
          batch.set(newRef, { ...stage, createdAt: serverTimestamp() });
        });
        await batch.commit();
      } else {
        setStages(fetchedStages.sort((a, b) => (a.order || 0) - (b.order || 0)));
      }
    }, (error) => console.error("Error fetching stages:", error));

    // Meetings
    const meetingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'meetings');
    const unsubMeetings = onSnapshot(meetingsRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setMeetings(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
    }, (error) => console.error("Error fetching meetings:", error));

    // Tasks
    const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
    const unsubTasks = onSnapshot(tasksRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTasks(data.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds));
    }, (error) => console.error("Error fetching tasks:", error));

    return () => {
      unsubStages();
      unsubMeetings();
      unsubTasks();
    };
  }, [user]);

  // --- Actions ---

  const handleAddMeeting = async () => {
    if (!newMeeting.title) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'meetings'), {
        ...newMeeting,
        createdAt: serverTimestamp()
      });
      // Reset form including new fields
      setNewMeeting({ 
        title: '', 
        date: new Date().toISOString().split('T')[0], 
        summary: '', 
        fullDoc: '',
        link: '',
        attendees: [] 
      });
      setIsMeetingModalOpen(false);
    } catch (e) {
      console.error("Error adding meeting", e);
    }
  };

  const handleAddTask = async () => {
    if (!newTask.title) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), {
        ...newTask,
        status: 'todo',
        createdAt: serverTimestamp()
      });
      setNewTask({ title: '', assignee: TEAM[0].id, priority: 'normal' });
      setIsTaskModalOpen(false);
    } catch (e) {
      console.error("Error adding task", e);
    }
  };

  const updateStageStatus = async (id, currentStatus) => {
    const nextStatus = currentStatus === 'pending' ? 'in-progress' : currentStatus === 'in-progress' ? 'done' : 'pending';
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stages', id);
    await updateDoc(ref, { status: nextStatus });
  };

  const toggleTaskStatus = async (id, currentStatus) => {
    const nextStatus = currentStatus === 'todo' ? 'done' : 'todo';
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id);
    await updateDoc(ref, { status: nextStatus });
  };

  const deleteTask = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
  };

  const deleteMeeting = async (id) => {
    if (confirm('האם אתה בטוח שברצונך למחוק תיעוד זה?')) {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'meetings', id));
    }
  };

  const toggleMeetingAttendee = (name) => {
    setNewMeeting(prev => {
      const exists = prev.attendees.includes(name);
      return {
        ...prev,
        attendees: exists 
          ? prev.attendees.filter(a => a !== name)
          : [...prev.attendees, name]
      };
    });
  };

  // --- UI Components ---

  const StatusBadge = ({ status }) => {
    const styles = {
      'pending': 'bg-slate-100 text-slate-500 ring-1 ring-slate-200',
      'in-progress': 'bg-blue-50 text-blue-600 ring-1 ring-blue-200',
      'done': 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200'
    };
    const labels = {
      'pending': 'ממתין',
      'in-progress': 'בביצוע',
      'done': 'הושלם'
    };
    return (
      <span className={`px-2.5 py-1 rounded-full text-[11px] font-semibold tracking-wide ${styles[status]}`}>
        {labels[status]}
      </span>
    );
  };

  const AssigneeBadge = ({ id }) => {
    const member = ALL_PEOPLE.find(m => m.id === id);
    if (!member) return null;
    return (
      <span className={`flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium border ${member.color}`}>
        <User size={12} />
        {member.name}
      </span>
    );
  };

  const AttendeeTag = ({ name }) => {
    const person = ALL_PEOPLE.find(p => p.name === name);
    const style = person ? person.color : 'bg-slate-100 text-slate-600 border-slate-200';
    return (
      <span className={`text-[11px] px-2 py-0.5 rounded-full border ${style}`}>
        {name}
      </span>
    );
  };

  // --- Render Sections ---

  const renderOverview = () => (
    <div className="space-y-8 animate-in fade-in duration-500">
      {/* Header Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-start gap-4">
          <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
             <Target size={22} />
          </div>
          <div>
            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">לקוח</h3>
            <div className="font-bold text-slate-900 text-lg leading-none mb-1">{PROJECT_DETAILS.clientName}</div>
            <div className="text-sm text-slate-500">{PROJECT_DETAILS.contactPerson}</div>
          </div>
        </div>
        
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-start gap-4">
          <div className="p-3 bg-purple-50 text-purple-600 rounded-xl">
             <FileText size={22} />
          </div>
          <div>
            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">מודולים</h3>
            <div className="flex flex-wrap gap-1.5">
              {PROJECT_DETAILS.modules.slice(0, 3).map((mod, i) => (
                <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded-full border border-slate-200">
                  {mod.split(' ')[0]}...
                </span>
              ))}
              {PROJECT_DETAILS.modules.length > 3 && <span className="text-[10px] text-slate-400">+1</span>}
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Timeline / Stages */}
        <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
            <h2 className="font-bold text-slate-800 flex items-center gap-2">
              <Layout size={20} className="text-blue-500"/>
              שלבי הפרויקט
            </h2>
            <div className="text-xs font-medium px-2 py-1 bg-blue-50 text-blue-700 rounded-md">
              {Math.round((stages.filter(s => s.status === 'done').length / (stages.length || 1)) * 100)}% הושלם
            </div>
          </div>
          
          <div className="p-6 relative">
            <div className="absolute top-8 bottom-8 right-[43px] w-0.5 bg-slate-100"></div>
            <div className="space-y-6">
              {stages.map((stage) => (
                <div 
                  key={stage.id} 
                  onClick={() => updateStageStatus(stage.id, stage.status)}
                  className="relative flex gap-5 group cursor-pointer"
                >
                  <div className={`
                    relative z-10 w-9 h-9 rounded-full flex items-center justify-center border-4 border-white shadow-sm transition-all duration-300
                    ${stage.status === 'done' ? 'bg-emerald-500 text-white' : 
                      stage.status === 'in-progress' ? 'bg-blue-500 text-white ring-4 ring-blue-50' : 'bg-slate-100 text-slate-300'}
                  `}>
                    {stage.status === 'done' ? <CheckCircle2 size={16} /> : 
                     stage.status === 'in-progress' ? <Clock size={16} /> : <Circle size={16} />}
                  </div>
                  
                  <div className={`flex-1 p-4 rounded-xl border transition-all duration-200 ${stage.status === 'in-progress' ? 'bg-blue-50/50 border-blue-100 shadow-sm' : 'bg-white border-slate-100 hover:border-blue-200 hover:bg-slate-50'}`}>
                    <div className="flex justify-between items-start mb-1">
                      <h3 className={`font-bold ${stage.status === 'done' ? 'text-slate-400' : 'text-slate-800'}`}>
                        {stage.title}
                      </h3>
                      <StatusBadge status={stage.status} />
                    </div>
                    {stage.description && (
                      <p className="text-xs text-slate-500 leading-relaxed">{stage.description}</p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Quick Stats / Side */}
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h3 className="text-slate-500 text-sm font-semibold mb-4">סטטוס משימות</h3>
            <div className="flex items-center gap-4 mb-6">
              <div className="text-4xl font-extrabold text-slate-800">
                {tasks.filter(t => t.status === 'todo').length}
              </div>
              <div className="text-sm text-slate-400 leading-tight">
                משימות<br/>פתוחות
              </div>
            </div>
            {tasks.slice(0, 3).map(task => (
              <div key={task.id} className="flex items-center gap-3 py-2 border-b border-slate-50 last:border-0">
                <div className={`w-2 h-2 rounded-full ${task.status === 'done' ? 'bg-emerald-400' : 'bg-amber-400'}`}></div>
                <div className="text-sm text-slate-600 truncate flex-1">{task.title}</div>
              </div>
            ))}
            <button 
              onClick={() => setActiveTab('tasks')}
              className="w-full mt-4 py-2 text-xs font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
            >
              לכל המשימות
            </button>
          </div>

          <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-md text-white">
            <h3 className="text-white/80 text-sm font-medium mb-1">פגישה אחרונה</h3>
            {meetings.length > 0 ? (
              <>
                <div className="text-xl font-bold mb-2">{meetings[0].title}</div>
                <div className="flex items-center gap-2 text-white/70 text-sm">
                  <Calendar size={14} />
                  {meetings[0].date}
                </div>
              </>
            ) : (
              <div className="text-white/60 text-sm">אין פגישות מתועדות</div>
            )}
            <button 
              onClick={() => setActiveTab('meetings')}
              className="mt-4 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors w-full text-center"
            >
              עבור ליומן
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  const renderMeetings = () => (
    <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
       <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-100 shadow-sm sticky top-0 z-10">
        <div>
          <h2 className="text-xl font-bold text-slate-800">יומן פגישות</h2>
          <p className="text-xs text-slate-400 mt-0.5">תיעוד מסודר כולל משתתפים (לקוח וצוות)</p>
        </div>
        <button 
          onClick={() => setIsMeetingModalOpen(true)}
          className="bg-blue-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 hover:bg-blue-700 transition-all shadow-md shadow-blue-200 active:scale-95"
        >
          <Plus size={18} />
          <span className="hidden sm:inline">תיעוד חדש</span>
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {meetings.length === 0 && (
          <div className="col-span-full text-center py-16 bg-white rounded-2xl border border-dashed border-slate-200">
            <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3">
              <MessageSquare size={32} className="text-slate-300" />
            </div>
            <h3 className="text-lg font-medium text-slate-700">היומן ריק</h3>
            <p className="text-slate-400 text-sm mt-1">עדיין לא תועדו פגישות בפרויקט זה</p>
          </div>
        )}
        {meetings.map((meeting) => (
          <div key={meeting.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group relative overflow-hidden flex flex-col">
            {/* Header / Top strip */}
             <div className="h-1 w-full bg-gradient-to-r from-blue-500 to-indigo-500"></div>
             
             {/* Delete Button (X) */}
             <button 
                onClick={(e) => {
                  e.stopPropagation();
                  deleteMeeting(meeting.id);
                }}
                className="absolute top-3 left-3 text-slate-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-full transition-colors z-10"
                title="מחיקת תיעוד"
              >
                <X size={18} />
              </button>

            <div className="p-6 flex-1">
              <div className="mb-4 pr-1">
                <div className="flex items-center gap-2 text-xs font-bold text-blue-600 mb-2">
                  <Calendar size={12} />
                  {meeting.date}
                </div>
                <h3 className="text-lg font-bold text-slate-800 leading-snug">{meeting.title}</h3>
                
                {meeting.link && (
                  <a 
                    href={meeting.link} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 mt-2 text-xs font-medium text-blue-600 hover:text-blue-800 hover:underline"
                  >
                    <LinkIcon size={12} />
                    לינק לפגישה
                  </a>
                )}
              </div>
              
              <div className="space-y-3">
                {/* Short Summary */}
                {meeting.summary && (
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div className="text-xs font-bold text-slate-400 mb-1">תקציר / נקודות חשובות</div>
                    <div className="text-slate-600 text-sm leading-relaxed whitespace-pre-wrap">
                      {meeting.summary}
                    </div>
                  </div>
                )}

                {/* Full Documentation */}
                {meeting.fullDoc && (
                  <div className="bg-white p-3 rounded-xl border border-slate-200">
                    <div className="flex items-center gap-2 text-xs font-bold text-slate-400 mb-2 border-b border-slate-100 pb-1">
                      <FileEdit size={12} />
                      תיעוד מלא / פרוטוקול
                    </div>
                    <div className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap max-h-40 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-slate-200">
                      {meeting.fullDoc}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {meeting.attendees && meeting.attendees.length > 0 && (
              <div className="px-6 pb-5 pt-0 mt-auto">
                <div className="flex flex-wrap gap-2">
                  {meeting.attendees.map((attendee, idx) => (
                    <AttendeeTag key={idx} name={attendee} />
                  ))}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );

  const renderTasks = () => {
    const filteredTasks = taskFilter === 'all' 
      ? tasks 
      : tasks.filter(t => t.assignee === taskFilter);

    return (
      <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
        <div className="flex flex-col md:flex-row md:justify-between md:items-center bg-white p-4 rounded-xl border border-slate-100 shadow-sm sticky top-0 z-10 gap-4">
          <div>
            <h2 className="text-xl font-bold text-slate-800">צ'ק ליסט משימות</h2>
            <p className="text-xs text-slate-400 mt-0.5">ניהול ותיוג משימות לצוות</p>
          </div>
          
          <div className="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0 w-full md:w-auto scrollbar-hide">
             <div className="flex bg-slate-50 p-1 rounded-lg border border-slate-200">
                <button 
                  onClick={() => setTaskFilter('all')}
                  className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all whitespace-nowrap ${taskFilter === 'all' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  הכל
                </button>
                {TEAM.map(member => (
                  <button 
                    key={member.id}
                    onClick={() => setTaskFilter(member.id)}
                    className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all whitespace-nowrap ${taskFilter === member.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    {member.name}
                  </button>
                ))}
             </div>
             <button 
              onClick={() => setIsTaskModalOpen(true)}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition-all shadow-md shadow-blue-200 active:scale-95 whitespace-nowrap"
            >
              <Plus size={16} />
              <span className="hidden sm:inline">חדש</span>
            </button>
          </div>
        </div>

        <div className="grid gap-3">
          {filteredTasks.length === 0 && (
            <div className="text-center py-16 bg-white rounded-2xl border border-dashed border-slate-200">
              <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3">
                <CheckSquare size={32} className="text-slate-300" />
              </div>
              <h3 className="text-lg font-medium text-slate-700">אין משימות להצגה</h3>
              <p className="text-slate-400 text-sm mt-1">
                {taskFilter === 'all' ? 'כל המשימות הושלמו, עבודה מעולה!' : 'לא נמצאו משימות עבור חבר צוות זה'}
              </p>
            </div>
          )}
          {filteredTasks.map((task) => (
            <div 
              key={task.id} 
              className={`
                bg-white p-4 rounded-xl shadow-sm border flex items-center justify-between group transition-all duration-200
                ${task.status === 'done' ? 'opacity-50 bg-slate-50 border-slate-100 grayscale' : 'border-slate-100 hover:border-blue-200 hover:shadow-md'}
              `}
            >
              <div className="flex items-center gap-5">
                <button 
                  onClick={() => toggleTaskStatus(task.id, task.status)}
                  className={`
                    w-6 h-6 rounded-md border flex items-center justify-center transition-all duration-200
                    ${task.status === 'done' ? 'bg-emerald-500 border-emerald-500 text-white shadow-sm' : 'border-slate-300 text-transparent hover:border-blue-500 bg-white'}
                  `}
                >
                  <CheckCircle2 size={14} />
                </button>
                <div>
                  <p className={`font-semibold text-base transition-colors ${task.status === 'done' ? 'line-through text-slate-400' : 'text-slate-800'}`}>
                    {task.title}
                  </p>
                  <div className="flex gap-2 mt-1.5 items-center">
                    <AssigneeBadge id={task.assignee} />
                    {task.priority === 'high' && (
                      <span className="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full ring-1 ring-red-100">דחוף</span>
                    )}
                  </div>
                </div>
              </div>
              <button 
                onClick={() => deleteTask(task.id)}
                className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors opacity-0 group-hover:opacity-100"
              >
                <Trash2 size={18} />
              </button>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // --- Modals ---
  
  const MeetingModal = () => (
    <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
        <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center shrink-0">
          <h3 className="font-bold text-slate-800 text-lg">תיעוד פגישה חדשה</h3>
          <button onClick={() => setIsMeetingModalOpen(false)} className="text-slate-400 hover:text-slate-600 bg-white hover:bg-slate-100 p-1 rounded-full transition-colors border border-transparent hover:border-slate-200">
            <Plus size={20} className="rotate-45" />
          </button>
        </div>
        <div className="p-6 space-y-5 overflow-y-auto">
          <div>
            <label className="block text-sm font-semibold text-slate-700 mb-1.5">נושא הפגישה</label>
            <input 
              type="text" 
              className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-sm"
              placeholder="לדוגמה: ישיבת אפיון UX"
              value={newMeeting.title}
              onChange={e => setNewMeeting({...newMeeting, title: e.target.value})}
              autoFocus
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-1.5">תאריך</label>
              <input 
                type="date" 
                className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-sm"
                value={newMeeting.date}
                onChange={e => setNewMeeting({...newMeeting, date: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-1.5">לינק (זום/מיט)</label>
              <input 
                type="url" 
                className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-sm"
                placeholder="https://..."
                value={newMeeting.link}
                onChange={e => setNewMeeting({...newMeeting, link: e.target.value})}
              />
            </div>
          </div>
          
          <div>
             <label className="block text-sm font-semibold text-slate-700 mb-2">משתתפים - צוות</label>
             <div className="flex flex-wrap gap-2 mb-3">
                {TEAM.map(member => {
                  const isSelected = newMeeting.attendees.includes(member.name);
                  return (
                    <button
                      key={member.id}
                      onClick={() => toggleMeetingAttendee(member.name)}
                      className={`
                        px-3 py-1.5 rounded-full text-xs font-medium border transition-all
                        ${isSelected 
                          ? 'bg-blue-100 text-blue-700 border-blue-200 ring-2 ring-blue-500/20' 
                          : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300'}
                      `}
                    >
                      {member.name} {isSelected && '✓'}
                    </button>
                  );
                })}
             </div>
             
             <label className="block text-sm font-semibold text-slate-700 mb-2">משתתפים - לקוח</label>
             <div className="flex flex-wrap gap-2">
                {CLIENTS.map(client => {
                  const isSelected = newMeeting.attendees.includes(client.name);
                  return (
                    <button
                      key={client.id}
                      onClick={() => toggleMeetingAttendee(client.name)}
                      className={`
                        px-3 py-1.5 rounded-full text-xs font-medium border transition-all
                        ${isSelected 
                          ? 'bg-orange-100 text-orange-700 border-orange-200 ring-2 ring-orange-500/20' 
                          : 'bg-white text-slate-600 border-slate-200 hover:border-orange-300'}
                      `}
                    >
                      {client.name} {isSelected && '✓'}
                    </button>
                  );
                })}
             </div>
          </div>

          <div>
            <label className="block text-sm font-semibold text-slate-700 mb-1.5">תקציר / נקודות חשובות</label>
            <textarea 
              rows="2"
              className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none resize-none transition-all text-sm"
              placeholder="סיכום קצר..."
              value={newMeeting.summary}
              onChange={e => setNewMeeting({...newMeeting, summary: e.target.value})}
            ></textarea>
          </div>

          <div>
            <label className="block text-sm font-semibold text-slate-700 mb-1.5">תיעוד מלא / פרוטוקול</label>
            <textarea 
              rows="6"
              className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none resize-none transition-all text-sm"
              placeholder="כאן ניתן לכתוב את כל מה שנאמר בפגישה..."
              value={newMeeting.fullDoc}
              onChange={e => setNewMeeting({...newMeeting, fullDoc: e.target.value})}
            ></textarea>
          </div>
        </div>
        <div className="p-4 bg-slate-50 border-t border-slate-100 mt-auto shrink-0">
          <button 
            onClick={handleAddMeeting}
            className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200"
          >
            שמור סיכום
          </button>
        </div>
      </div>
    </div>
  );

  const TaskModal = () => (
    <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col">
        <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center shrink-0">
          <h3 className="font-bold text-slate-800 text-lg">יצירת משימה חדשה</h3>
          <button onClick={() => setIsTaskModalOpen(false)} className="text-slate-400 hover:text-slate-600 bg-white hover:bg-slate-100 p-1 rounded-full transition-colors border border-transparent hover:border-slate-200">
            <Plus size={20} className="rotate-45" />
          </button>
        </div>
        <div className="p-6 space-y-5">
          <div>
            <label className="block text-sm font-semibold text-slate-700 mb-1.5">תיאור המשימה</label>
            <input 
              type="text" 
              className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-sm"
              placeholder="מה צריך לבצע?"
              value={newTask.title}
              onChange={e => setNewTask({...newTask, title: e.target.value})}
              autoFocus
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-1.5">אחראי לביצוע</label>
              <select 
                className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none bg-white text-sm"
                value={newTask.assignee}
                onChange={e => setNewTask({...newTask, assignee: e.target.value})}
              >
                {TEAM.map(member => (
                  <option key={member.id} value={member.id}>{member.name} ({member.role})</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-1.5">דחיפות</label>
              <select 
                className="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none bg-white text-sm"
                value={newTask.priority}
                onChange={e => setNewTask({...newTask, priority: e.target.value})}
              >
                <option value="normal">רגילה</option>
                <option value="high">גבוהה</option>
              </select>
            </div>
          </div>
        </div>
        <div className="p-4 bg-slate-50 border-t border-slate-100 mt-auto shrink-0">
          <button 
            onClick={handleAddTask}
            className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200"
          >
            צור משימה
          </button>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-blue-100" dir="rtl">
      {/* Sidebar / Navigation */}
      <div className="md:fixed md:w-72 md:h-full bg-white border-l border-slate-200/60 shadow-xl shadow-slate-200/50 z-20 flex flex-col">
        <div className="p-8 pb-6">
          <div className="flex items-center gap-3 text-blue-600 font-black text-2xl tracking-tight">
            <div className="bg-blue-600 text-white p-2 rounded-lg">
              <Layout size={20} className="fill-current" />
            </div>
            <span className="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-blue-500">ProjectHub</span>
          </div>
          <p className="text-xs font-medium text-slate-400 mt-2 pr-1">ניהול פרויקט: {PROJECT_DETAILS.clientName}</p>
        </div>
        
        <nav className="flex-1 px-4 space-y-1.5">
          <button 
            onClick={() => setActiveTab('overview')}
            className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl transition-all duration-200 font-medium text-sm
              ${activeTab === 'overview' ? 'bg-blue-50 text-blue-700 shadow-sm ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}
          >
            <Layout size={18} />
            לוח בקרה ושלבים
          </button>
          <button 
            onClick={() => setActiveTab('meetings')}
            className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl transition-all duration-200 font-medium text-sm
              ${activeTab === 'meetings' ? 'bg-blue-50 text-blue-700 shadow-sm ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}
          >
            <MessageSquare size={18} />
            יומן פגישות
          </button>
          <button 
            onClick={() => setActiveTab('tasks')}
            className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl transition-all duration-200 font-medium text-sm
              ${activeTab === 'tasks' ? 'bg-blue-50 text-blue-700 shadow-sm ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}
          >
            <CheckSquare size={18} />
            משימות
          </button>
        </nav>

        <div className="p-4 bg-slate-50/50 m-4 rounded-2xl border border-slate-100">
          <h4 className="text-[11px] font-bold text-slate-400 uppercase mb-4 px-1 tracking-wider">צוות הפרויקט</h4>
          <div className="space-y-3">
            {TEAM.map(member => (
              <div key={member.id} className="flex items-center gap-3 group">
                <div className={`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold transition-transform group-hover:scale-110 shadow-sm ${member.color.split(' ')[0]} ${member.color.split(' ')[1]}`}>
                  {member.name[0]}
                </div>
                <div>
                  <div className="text-sm font-bold text-slate-700 group-hover:text-blue-600 transition-colors">{member.name}</div>
                  <div className="text-xs text-slate-400">{member.role}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="md:mr-72 min-h-screen">
        <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-10 px-6 py-4 flex justify-between items-center md:hidden">
           <div className="font-bold text-lg text-slate-800">ProjectHub</div>
        </header>
        
        <div className="p-6 md:p-10 max-w-6xl mx-auto">
          {loading ? (
             <div className="flex h-[50vh] items-center justify-center text-slate-400 flex-col gap-4">
                <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span>טוען נתונים...</span>
             </div>
          ) : (
            <>
              {activeTab === 'overview' && renderOverview()}
              {activeTab === 'meetings' && renderMeetings()}
              {activeTab === 'tasks' && renderTasks()}
            </>
          )}
        </div>
      </main>

      {/* Modals */}
      {isMeetingModalOpen && <MeetingModal />}
      {isTaskModalOpen && <TaskModal />}
    </div>
  );
}
